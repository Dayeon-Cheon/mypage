<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‚´ì¼ë°°ì›€ìº í”„ë¥¼ ì‹œì‘í•˜ë©°</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script type="module">
      // Firebase SDK ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        collection,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // Firebase êµ¬ì„± ì •ë³´ ì„¤ì •
      const firebaseConfig = {
        apiKey: "AIzaSyAR36yFasmU_m6vNAT0n8bg-GwEsZKUE0o",
        authDomain: "sparta-10a3a.firebaseapp.com",
        projectId: "sparta-10a3a",
        storageBucket: "sparta-10a3a.appspot.com",
        messagingSenderId: "751870807401",
        appId: "1:751870807401:web:e15a61affb9698566a41f8",
        measurementId: "G-XWRJREERWJ",
      };

      // Firebase ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      $("#postingbtn").click(async function () {
        let image = $("#image").val();
        let comment = $("#comment").val();

        if (image.length === 0 || comment.length === 0) {
          alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          window.location.reload();
        }

        const d = new Date();
        let year = d.getFullYear();
        let month = d.getMonth() + 1;
        let day = d.getDate();
        let date = `${year}/${month}/${day}`;

        let doc = {
          image: image,
          comment: comment,
          date: date,
        };

        await addDoc(collection(db, "today"), doc);

        window.location.reload();
      });

      // ì˜¤ëŠ˜ì˜ ë‹¤ì§ ë“±ë¡í•˜ê¸° í† ê¸€
      $("#savebtn").click(async function () {
        $("#postingbox").toggle();
      });

      // ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
      let docs = await getDocs(collection(db, "today"));

      docs.forEach((doc) => {
        let row = doc.data();

        let image = row["image"];
        let comment = row["comment"];
        let date = row["date"];

        let tempHtml = `
              <div class="col">
                <div class="card h-100">
                  <div class="card-header">
                    <small class="text-body-secondary">${date}</small>
                  </div>
                  <img
                    src="${image}"
                    class="card-img-top"
                    alt="..."
                  />
                  <div class="card-body">
                    <p class="card-text">${comment}</p>
                  </div>
                </div>
              </div>`;
        $("#card").append(tempHtml);
      });

      // í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ê¸°ì˜¨ ê°€ì ¸ì˜¤ê¸°
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          let latitude = position.coords.latitude;
          let longitude = position.coords.longitude;

          let apiKey = "d6ab5970bcda922ee997dced7f1bc072";
          let apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&units=metric&appid=${apiKey}`;

          fetch(apiUrl)
            .then((response) => response.json())
            .then((data) => {
              let temp = data.main.temp;
              $("#temp").text(`ğŸŒ¡ í˜„ì¬ ìœ„ì¹˜ ê¸°ì˜¨ : ${temp}Â°C`);
            });
        });
      }

      // ì„œìš¸ì˜ í˜„ì¬ ë¯¸ì„¸ë¨¼ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      // let url = "http://spartacodingclub.shop/sparta_api/seoulair";
      // fetch(url)
      //   .then((res) => res.json())
      //   .then((data) => {
      //     // console.log(data);
      //     let airQualityIndex = data["RealtimeCityAir"]["row"][0]["IDEX_MVL"];
      //     let airQuality = data["RealtimeCityAir"]["row"][0]["IDEX_NM"];

      //     let $msg = "";

      //     if (airQualityIndex === -99) {
      //       $msg = `ì ê²€ì¤‘ ì…ë‹ˆë‹¤.`;
      //     } else {
      //       $msg = `${airQualityIndex} (${airQuality})`;
      //     }

      //     alert("ì„œìš¸ì˜ í˜„ì¬ ë¯¸ì„¸ë¨¼ì§€ ë†ë„: " + $msg);
      //   });
    </script>
  </head>
  <body>
    <div class="mytitle">
      <h1>â˜€ï¸ ë‚´ì¼ë°°ì›€ìº í”„ë¥¼ ì‹œì‘í•˜ë©° â˜€ï¸</h1>
      <button id="savebtn">ì˜¤ëŠ˜ì˜ ë‹¤ì§ ë“±ë¡í•˜ê¸°</button>
      <span id="temp"></span>
    </div>
    <div class="mypostingbox" id="postingbox">
      <div class="form-floating mb-3">
        <input
          type="text"
          class="form-control"
          id="image"
          placeholder="ì˜¤ëŠ˜ ë‚´ ê¸°ë¶„ì„ í‘œí˜„í•˜ëŠ” ì´ë¯¸ì§€"
        />
        <label for="image">ì˜¤ëŠ˜ ë‚´ ê¸°ë¶„ì„ í‘œí˜„í•˜ëŠ” ì´ë¯¸ì§€</label>
      </div>
      <div class="form-floating mb-3">
        <input
          type="text"
          class="form-control"
          id="comment"
          placeholder="ì˜¤ëŠ˜ì˜ ë‹¤ì§ í•œ ë§ˆë””"
        />
        <label for="comment">ì˜¤ëŠ˜ì˜ ë‹¤ì§ í•œ ë§ˆë””</label>
      </div>
      <div class="mybtn">
        <button id="postingbtn" type="button" class="btn btn-secondary">
          ë“±ë¡í•˜ê¸°
        </button>
      </div>
    </div>
    <div class="mycards">
      <div id="card" class="row row-cols-1 row-cols-md-4 g-4"></div>
    </div>
  </body>
</html>
